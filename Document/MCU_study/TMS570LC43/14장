14장에서는 장치의 오실레이터 및 PPL clock 소스 경로에 대한 설명이다.

14.1 소개

크리스털과 공명기가  OSCIN and OSCOUT에 연결되면,

오실레이터 매크로는 input 파형을 생성하기위해 크리스털과 공명기를 구동시킨다.

오실레이터는 클럭소스 0을 직접적으로 사용가능하고, 오실레이터 클럭은 PLL에 입력된다.

오실레이터 주파수는 계속적으로 clock detect회로에 의해 모니터링 되어진다.

고정된 범위에서 주파수가 벗어나게 된다면, 오실레이터 내부에서 발생된 clock이 free-running주파수로 clock detect가 스위치를 한다. (오실레이터 내부에서 발생된 clock의 발견은 LPO가 함)

PLL은 입력주파수를 더높게 곱하기 위해 사용된다.

PLL의 주파수 합성은 외부크리스털또는 공명기로 보다 편리하게 높은 주파수를 생성한다.

게다가 PLL은 크리스털 또는 공명기에서 오는 여러 주파수 옵션중 하나를 유연하게 합성할수 있다.

주파수 모듈레이션은 합성된 주파수 위에 겹쳐놓을수 있는 역할해줌.

이 모듈레이션은 어떤 장치로 부터 오는 전기적 방사선의 충돌을 줄이는 역할을 해준다.

14.1.1 특징

클럭소스의 주요 특징:

*오실레이터는 크리스털과 공명기를 조정할수있다. 또는 외부소스로부터 조정되어지기도 한다.

*클럭감지기는 오실레이터의 주파를 계속적으로 모니터링하고,

 오실레이터의 failure 클럭을 자동으로 free-running클럭으로 조정해준다.

*FM-PLL은 변조모드와 비변조모드가 있다.

*파형주파수 감지기는 기준주파수를 기준으로 lock을 확실히 걸어둔다.

*공식

-NR:입력클록에 대한 사전분배기

-NF:(전력)증배기

-OD,R:나누기

*PLL은 변조가 가능한 상태로 사용할수있다.

-NS:변조 횟수

-NV:변조 깊이(심도)

*슬립제어기는 오실레이터의 리셋또는 자동스위치오버를 포함한 PLL의 실패사항을 유연하게 응답한다.

14.2 퀵 스타트

14-1의 그림은 오실레이터와 PLL clock 경로 그림이다.

reset파워가 켜지는 동안 오실레이터와 LPO(Low Power Osillator)가 기본적으로 활성화가 된다.

reset파워가 켜진후, high-level이 해제가 되고, 클럭감지기는 오실레이터를 모니터링하기 시작한다.

만약 오실레이터가 유효한 범위내에 있으면, 오실레이터는 이 장치가 종료될때까지 default 클럭을 유지한다.

만약 오실레이터가 유효한 범위내에 없으면, 클럭감지기가 LPO의 높은 주파수클록을 기본클럭으로 사용한다.

LPO는 넓은범위의 주파수영역을 가지고,클럭감지기 창을 개선하기위해 LPO가 손질(trim)하고 커다란 창을 생성한다.

최초의 trim값은 플래시메모리의 한 섹션에 저장된다.

소프트웨어는 플래시의 초기 트림값을 읽을수 있고, 제어 레지스터를 쓸수 있다.

PLL은 파워업 일때, 기본적으로 비활성화 되어있다.

PLL(PLLCTL1,PLLCTL2)는 원하는 출력주파수를 설정하도록 구성이 되어있다.

두번째 PLL은 PLLCTL3에 구성되고 활성화 되어야한다.

각각의 PLL에는 PLL잠금 유효비트를 가지고 있다.

클럭도메인 소스로 PLL클럭을 선택하기전에, 도메인 모듈은 새 주파수를 허용할수 있도록 구성되어야 한다.

14.3 오실레이터

PLL을 통한 클럭발생 경로는 오실레이터에서 시작된다.

오실레이터는 OSCIN,OSCOUT,Kelvin_GND 세가지로 나뉜다.

1.오실레이터는 로드와 탱크회로를 사용해 외부 크리스털과 공명기에서 피드백(positive)을 생성한다.

이 피드백의 아웃풋 파형의 진폭이 증가하면 전압파형은 증가하는 진폭을 감싸는것을 보여준다.

오실레이터는 크리스털주파수를 조정할수 있다.

OSCIN에서 인풋 파형을 보면 전압파형은 AC결합이 되어지고, OSCOUT의 파형의 필터링되어진 버전이다.

크리스털과 공명기의 통과주파수 기능으로 OSCOUT의 왜곡된 파형을 제거하고 sin곡선이 남게 된다.

2.오실레이터는 또한 스퀘어링 업을 위해 입력파형을 가지고있다.

스퀘어링 업은 sin곡선을 core로직level에서 구형파로 전환하는 기능을 한다.

오실레이터가 가지는 주파수 범위는 외부 크리스털과 공명기의 능력을 조정하면서 알아낸다.(피드백경로를 통해서)

만약 클럭이 직접적으로 오실레이터에 드라이빙 되어지면,

피드백경로는 관련이없고,주파수 범위는 순방향 경로에 의해서 결정된다(일반적으로 더 높은 주파수를 허용)

14.3.1 오실레이터 실행

오실레이터는 3.3v로 동작하며,oscout노드로 전류를 구동하기 위해 정전류소스를 사용한다.

 내부트랜지스터는 전류를 GND로 전류의 선로를 바꾼다.

이 전류는 ocsout의 전압파형을 구동한다.

14.3.2 Oscillator Enable

nPORRST가 낮을때 오실레이터는 비동기적으로 실행된다.(여기서 nPORRST는 단순히 포트로 보면됨)

오실레이터는 CSDIS에서 비트 0을 클리어하거나 CSDIS시스템및 주변제어 장치에 의해 설정한다.

비트는 오실레이터로 시작신호를 보낸다.

CSDIS의 비트 0은 기본적으로 시스템 또는 파워 온 리셋시 0으로 클리어되어 오실레이터가 기본적으로 시작된다.

14.3.3 Oscillator Disable

클럭소스는 클럭소스 비활성화 레지스터에서 적절한 비트를 설정하거나, 그 레지스터 시스템및 주변제어장치 레지스터의 클럭소스 비활성화세트 레지스터에서 적절한 비트를 설정하여

비활성화 한다.

-> 비활성화 레지스터에서 적절한 비트를 주어서 비활성화한다는 뜻.

14.4 Low Power Oscillator and Clock Detect (LPOCLKDET)

LPO는 두개의 오실레이터가 존재한다. ( HF-LPO , LF-LPO)

lpo와 클럭 detect는 릴랙싱오실레이터를 사용하여 엄격하게 제어되지 않는 내부 클럭 주파수를생성한다.

이 주파수는 오실레이터의 입력주파수를 모니터링하는게 사용되고, GCM의 독립클럭 소스로

사용가능함.

HF-LPO:공식 주파수 9.6MHz와 5.5MHz~19.5MHz 범위내에서 GCM에서 클록소스 5로 발생한다.

LF-LPO:공식 주파수 85kHz와 5.5MHz~19.5MHz 범위내에서 GCM에서 클록소스 4로 발생한다.

LPO는 단일전류응 사용하고 두개의 다른 비교측정기가 동작하여, HF-LPO와 LF-LPO의 주파수를

생성한다.

LPo는 4개의 다른비트로 구성되어있다.

CSDIS.(5:4), HFTRIM(4:0), LFTRIM(4:0), and BIASEN.

CSDIS 5는 HF-LPO

CSDIS 4는 LF-LPO

14.4.1 Clock Detect

Clock Detect는 다른클럭의 rising clock 사이에서 하나의 rising clock 클럭을 확인하면서

일을 한다. 그 결과 부정확한 flaging 과 반복되느 주파수와 과도한 조건으로 인한 실패를한다.

low end of the clock detect는 일시적으로 낮은 펄스를 무시한다. (적어도 12개의 HF LPO 사이클의 낮은 펄스)

NOTE

HF LPO주파수는 오실레이터에 대한 비교 주파수이다.

HF LPO 주파수를 비활성화하기 전에 clock detect를 비활성화해야 합니다.

만약에 HF LPO가 비활성화 되기전에 clock detect가 비활성화가 되지 않는다면,

clock detect 서킷은 오실레이터는 빠르게 동작하여서 실패하게될것이다.(존재하지 않는 HFLPO에 비해)

clock detect 서킷은 클럭이 존재하지않은 상태로 인식이 되고,

유효한 클럭없이 장치를 떠납니다.

14.4.2 Behavior on Oscillator Failure

오실레이터주파수가 실패하여 clock detect에 적용되는  사례:

오실레이터 대신 HF LPO클럭을 GCM clock 소스0으로 대체할때.

PLL 대신 HF LPO클럭을 GCM clock 소스1 로 대체할때.

HF LPO 신호가 3개의 다른 클럭소스로 이용가능한 사례:

GCM clock 소스0

GCM clock 소스1

GCM clock 소스5

자동으로 스위치오버된 오실레이터에서 HF LPO는 감소 된 주파수로 실행하고 외부 크리스털 / 공진기로 인한 문제에 대응할 수 있습니다

14.4.3 Recovery from Oscillator Failure

오실레이터가 작동실패를 하면 클럭감지스위치는 HF LPO주파수를 오실레이터 주파수로 대신해서

GCM으로 스위칭한다.

오실레이터 작동실패 flag는 GS레지스터시스템과 주변제어장치에 셋팅되어짐.

14.4.3 Recovery from Oscillator Failure

오실레이터가 고장이나면, 클럭감지기는 HF LPO주파수를 오실레이터 소스로 GCM(Global Clock Moduel)으로 전환한다.

오실레이터는 다음과 같은 절차를 통해 다시 활성화 될 수 있다.

(단, 하드fault로 인한 실패는 다시 활성화 할 수 없다)

1. 오실레이터에서 HF LPO로 모든 클럭도메인을 전환한다.

2. PLL을 사용한다면, 시스템주변장치와 CSDISSET(Clock Source Disable Set Registers)에 적절한 비트를 설정하여 PLL을 비활성화 한다.

3. CSDISSET에서 적절한 비트를 설정하여 오실레이터를 비활성화 한다. 이 동작은 클럭감지를 재설정하고, 오실레이터가 GCM을 통해 전파가 되도록한다.

4. CSDISSET에 적절한 비트를 설정하여 오실레이터를 다시 활성화한다

5. GLOBSTAT(Global Status Register)의 오실레이터 실패flag를

비트 1을 사용하여 지운다. PLL 슬립비트는 오실레이터 고장시에도 설정할수 있고, 지울수도 있다.

6. 클럭 도메인을 오실레이터로 다시 전환한다.

7. CDDISCLK에 적절한 비트를 설정하여 PLL을 다시 활성화한다.

14.4.4 LPOCLKDET Enable (LPO 클럭감지 활성?)

nPORRST가 낮을 때 LPO가 기본적으로 활성화된다.

이 시간동안 현재 소스는 초기화 되고, 초기화 될 때까지

휴식오실레이터 상태로 유지한다.

전류 소스가 HF LPO와 LF LPO를 방출한후, 이 클럭 주파수는

최종주파수로 돌려진다.

마지막주파수는 nPORRST 가 활성화되거나 풀어진 이후 달성되어질수 있다. 

nPORRST 가 해제된 후, HF LPO 유효 신호는 32 HF LPO클럭 사이클후에 설정된다.

오실레이터와 HFLPO가 유효하면 클럭감지기는 활성화된다.

리셋 상태에서 오실레이터 고장이 발생할수 있기 때문에,

클럭검출로직은 오버라이드경로를 제공해야한다.

만약 HFLPO가 유효하고 오실레이터 유효하지않는다면,

클럭 감지회로는 16K LFLPO사이클 이후 활성화 될 것이다.

14.4.4 LPOCLKDET Disable (LPO 클럭검출 비활성?)

14.4.5.1 Disable Clock Detect

클럭감지회로는 비활성화될 수있다. 이 클럭감지비활성은

보호를 위해 2비트 키를 사용한다.

*RANGE DET ENA SSET (CLKTEST.24)가 1로 설정되어야 한다.

*RANGE DET CTRL (CLKTEST.25)가 0으로 클리어 되어야한다.

이 경우, LPO HF와LF 클럭은 여전히 활성상태이지만 클럭검출회로는 disalbe 상태이다.

클럭검출은 무조건 GCM_CLK_SRC(0)을 오실레이터로 다시 전환해주어야하므로 주의 해야한다.

클럭감지회로를 비활성화 하기전에 오실레이터가 양호한지 확인을 해야한다.

14.4.5.2 Disable LPO HF and LF Clocks

휴식오실레이터 클럭을 리셋상태로 유지함으로써 LPO가 disable이 될 수 있다.

클럭감지기는 비활성화되어야하며, HF또는 LF클럭을 사용하는

어떤 클럭 도메인은 다른 클럭소스로 전환되어야 한다.

LPO HF클럭은 CSDIS.5를 재설정한다.

CSDIS.5는 레지스터의 나머지 부분을 방해하지 않고 특정비트를 설정하는 쉬운 방법으로 설정을 한다. HF LPO클럭은 CDDIS가 설정된 후, HFLPO사이ᅟᅳᆯ을 비활성화 한다.


14.4.5.3 Disable LPO Current Bias

클럭검출이 비활성화 되고 HF와LF클럭소스가 비활성된후 LPO전류소스가 비활성될 수 있다.

이 전류소스를 끄면  LPOCLKDET이 최저 전력구성으로 설정된다.

바이어스는  BIAS ENABLE bit를 지우면 비활성화 할수 있다.

바이어스 전류가 비활성화되었을 때 LPO를 다시 시작하려면 

전류소스를 먼저 초기화 해야한다. 따라서 웜 재시작보다 느리다.

14.4.6 Trimming the HF LPO Oscillator

HFLPO 범위는 장치마다 약 9.6MHz 정도로 다양하다.

크리스탈과 공명기의 정밀한 모니터링을 제공하기 위해 오실레이터는 다듬는게(trimming) 좋다.

HFLPO를 다듬을 때 트림 값을 변경하여 큰 값으로 변경하지 않는 것이 좋다. 초기 트림설정 이후, 결과 주파수를 결정하기 위해 듀얼클럭비교 모듈을 사용하여 LPOMONCTL에서 추가 트리밍을 수행 할 수있다. 

14.5 PLL

PLL은 입력클럭에서 나온 출력주파수들을 합성하는 역할을 해준다.fm PLL은 낮은 주파수로 입력된 레퍼런스 입력값을 나눈다.

PLL은 내부주파수에 NF를 곱해서 VCO 출력클럭주파수를 얻는다.

유효한 주파수는 표 14-1에 나와 있다.

표 14-2는 해당 인코딩이 PLL 비트 필드에서 생성되는 방법을 보여준다.

NOTE: ODPLL change should occur prior to enabling asynchronous clock domains 

비동기 클록 도메인을 활성화하기 전에 ODPLL 변경이 발생해야한다. ODPLL 비트 필드를 변경하면 PLL CLK이 게이트되므로 ODPLL에 대한 이러한 변경은 비동기 클럭 소스에 대한 클록 도메인을 구성하기 전에 완료되어야한다.

★14.5.1 Modulation

선택적으로 주파수는 조절할수 있다. 즉, 제어가 된 지터가 PLL의 기본주파수로 도입이 된다.

PLL이 변조모드로 사용되어질때, 작동가능한 모듈블럭이 PLL 주파수를 기본주파수로부터 오는 어떤 정의가 있다. 이 모듈레이션파형은 삼각형으로 되어져 있고, lock이 걸린 후에 사용할 수 있다.

이 모듈레이션은 디지털신호이고, 삼각형모양이 펼쳐져있다.

1. 모듈레이션 파형은 주파수의 일련의 단계로 구성되어져있다.

2.모듈레이션 주파수와 깊이는 둘다 그들의 디지털 특징때문에 잘 제어가 된다.

3. 평균 주파수는 활성화하기 전의 평균주파수보다 낮다. 그러나 모듈레이션의 깊이가 새롭게 평균주파수로 셋팅이 된다.

4.모듈레이션 주파수는 루프 대역보다 선택되어져야만 한다. 

실질적으로 NS가 20근처에 있어야함.

첫번째 식 모듈레이션의 사이즈

두번째 식은 모듈레이션 주기당 스텝수 = 2*ns

세번째 식은 모듈레이션의 깊이

네번째는 모듈레이션의 주파수

마지막식은 프로그램되어질때 MULMOD최소 주파수를 상쇄하다.

14.5.2 PLL Output Control

PLL의 output클럭 출력 형태는 slip 신호와 VALID이다.

RFSLIP : RFSLIP 신호는 CLK의 아웃풋이 INTCLK에 비해 너무 빠르게 실행되고있는 상태를 나타내며, 이 시스템및 주변제어장치의(GLBSTAT)에서 RFSLIP상태 플래그를 설정한다.

FBSLIP: CLK의 아웃풋이 INTCLK에 비해 너무 느리고 실행되고있는 상태를 나타내며, 역시 위와같이 플래그 설정을함.

PLL silp : 두개의 pll 슬립신호의 논리적 OR 이다.

일반적으로 이 신호는 장치에 통합된 슬립 신호를 생성하는 데 사용되어진다. 예를 들면, 에러로직이나 예외발생

NOTE: 슬립비트를 제거하려면, 먼저 PLL을 비활성화 해야한다.

VALID : 출력 클럭인 PLLCLK가 게이트로 제어되는지, 안되는지에 따라 구동된다.

그러나 valid신호는 PLL슬립신호에 따라 달라지므로 어느쪽이든 슬립하면 valid를 설정할수 없다.

PLL Clock : PLL 출력 클럭은 프로그래밍된 주파수에서 실행이된다. 활성화된 경우, 프로그래밍 된 주파수를 획득하는데 약간의 시간이 걸린다. 비슷하게, disable에도 약간의 타이밍과 제약이있다.


14.5.2.1 PLL Enable

PLL 제어 레지스터를 설정후, 클럭소스는 클럭소스 비활성화 레지스터에서 적절한 비트를 지우거나 시스템 및 주변장치 제어 레지스터릐 클럭소스 비활성화 clear 레지스터에서 적절한 비트를 설정하여 활성화 한다.

이 비트는 PLL에 신호를 보낸다.

1. PLL은 오실레이터가 켜져있는지 확인한다. 켜져있지 않으면

오실레이터를 켠다.

2. PLL은 PLL 시작 주파수지점에서 프로그래밍 된 주파수로 잠금 프로세스를 시작한다. 이 잠금기간동안 PLL슬립 신호는 일반적으로 활성화되며 PLL은 이 단계에서 신호를 마스크해제한다.

잠금단계에는 다음과 같은 시간이 소요된다.

3. 잠금 파형이 완성된후, PLL은 slip 신호를 시스템에 보낸다.

4. 슬립신호가 해제되고 클럭을 활성화 하기위한 지연이 완료되면 클럭이 이 시스템으로 해제되고 PLL의 해당CLKSRnV 비트가 유효상태레지스터에 설정된다.

14.5.2.2 PLL Disable

클럭소스는 클럭소스 비활성화 레지스터에 적절한 비트를 설정하거나 시스템 및 주변제어장치 레지스터의 클럭소스 비활성화 레지스터에 적절한 비트를 설정하여 비활성화된다.

이 비트는 클럭을 disable 시키지만 클럭이 클럭도메인의 소스로 더 이상 사용되지 않을때까지 동작을 강요하진 않는다.

PLL은 클록 도메인에 의해 클록이 더 이상 사용되지 않으면 disable 신호를 수신한다.

PLL내에서 클럭이 disable 되고, 클럭소스 유효상태의 PLL에 대한 적절한 비트를 주면 비활성화 상태가 된다. 그러면 PLL은 다음시간이 지나면 저전력 상태가 된다.

표참고 (14.5.2.2)

14.5.2.3 OD-Divider Change

PLL이 활성화 되어있는 동안 ODPLL 비트 필드가 변경되면 PLL이 클럭을 게이트 한다. PLL의 출력클럭은 3또는12 OSCIN클럭 사이클동안 게이트된다. post-ODCLK가 낮은 위상에서 게이트되기 때문에 디바이스로의 출력클럭은 항상 결함이 없더라도 높거나 낮은 위상으로 게이트 될수 있다.

14.5.2.4 Changing the PLL Operating Point While the PLL is Active

유효한비트가 설정되면 소프트웨어가 PLL로 값을 변경 할 수 있다.

VOC 주파수에 대한 변화율이 작은 경우, 이러한 변경은 즉석에서 수행할 수 있다. 이 모드네서 값은 PLL에 동기적으로 업데이트 되고 PLL은 클럭 또는 슬립비트를 게이팅하지 않고, 새값을 다시 잠금된다. 동작점이 너무 크게 바뀌면 슬립 비트가 설정된다.

반대로 VOC주파수의 변경이 큰 경우 값을 변경하기전에느 PLL을 비활성화 해야한다.

14.5.2.5 Summary of PLL Timings

PLL은 ODPLL변경중에 잠금기간을 제어하고 클럭을 비활성화하는 것 외에도 리셋 지연을 생성한다.



14.5.3 Behavior on PLL Fail

PLL은 PLL오류(슬립)에 유연하게 대응할 수 있다.
오실레이터와 마찬가지로 PLL클럭은 다음과 같이 구성된다.
(이 경우, 오실레이터는 GCM클럭소스1과 0을 제공한다. 또한,  오실레이터가 고장난 경우 LPOHF는 GCM클럭 소스0과1 모두의 소스가 된다.)

PLL 슬립출력은 PLL이 너무 빠르거나 느리게 실행중임을 나타낸다. 이러한 오류출력은 PLL이 잠금상태일때와 PLL이 작동하지 않을 때 전환된다.
PLL은 이 시간동안 이러한 슬립 출력을 차단하므로 PLL이 활성화된 동안에만 활성화 상태를 유지한다.

PLL이 잠긴후 활성상태인 슬립이 발생하면 PLL오류가 발생한다.
PLL은 실패에 대한 응답유연성을 향상시키는 슬립필터링을 사용한다.
슬립필터링 회로는 HFLPO를 기반으로 슬립을샘플링한다.
이 필터는 슬립이 인식되기전에 슬립신호가 활성화 되어야하는 연속적인 HFLPO사이클수에 맞게 정의되어있다.
이 슬립은 시스템및 주변제어장치 제어 레지스터의 GLBSTAT의 RFSLIP 및 FBSLIP상태 플래그로 걸어진다.


PLL은 에러신호처리를 자동으로 활성화/비활성화를 전환할수 있다.
에러신호가 활성화되면, PLL슬립은 리셋을 생성하도록 구성될수 있다.
오류 신호의 자동 스위티 오버 와 에러신호 억제는 슬립비트필드의 BPOS[1:0] (PLLCTL1.(30:29))에
의해 제어된다.

PLL슬립에 의한 방지는 자동으로 응답이된다.

*ESM과 예외를 생성되지 않는다.
*슬립시 리셋은 ROS비트 상태와 상관없이 생성되지 않는다.
*비트 상태는 BPOS[1:0]과 독립적으로 PLL slip 에 설정된다.

BPOS [1 : 0]이 활성화됬을때 (BPOS [1 : 0] = 00b 또는 01b 또는 11b):

*PLL슬립은 GCM 클럭 소스1로 클럭소스를 PLL에서 오실레이터로 이동시킨다.
*ESM과 예외가 생성된다.
*ROS(Reset On Slip)가 설정된 경우 슬립시 재설정이 생성된다.

14.5.4 Recovery from a PLL Failure

PLL1이 실패하면, PLL슬립은 유효한 플래그를 잠그고,
GCM 클럭소스1에 클럭소스를 PLL에서 오실레이터로 이동시킨다.
시스템및 주변장치제어 레지스터에 GLBSTAT에 있는 RFSLIP또는 FBSLIP 상태 플래그도 설정된다.
다음 절차를 통해 PLL1을 다시 활성화 할수 있다.

1.PLL1에서 오실레이터의 모든 클럭도메인을 전환한다.
2.CSDISSET(Clock Source Disable Set Register)에 적절한 비트를 설정하여 PLL1을 비활성화한다.
이 동작은 PLL을 비활성화 하고 슬립신호가 더이상 구동되지 않도록 한다.
슬립이 지워질때까지 유효기간은 해제되지 않는다.
3.비트에 1을 기록하여 시스템의 GLBSTAT에서 RFSLIP 또는 FBSLIP 상태의 플래그를 지운다.
4.CSDISCLR에 적절한 비트를 설정하여 PLL1을 다시 활성화 한다.
5.클럭도메인을 다시 PLL1으로 전환한다.

PLL2가 실패하면 PLL의 슬립으로 인해 유효한 플래그가 잠기게 된다.
PLL2에 대한 클럭소스의 자유로운 변경은 없다.
GLBSTAT에 있는 RFSLIP또는 FBSILP상태 플래그가 설정되어 있지 않다.
PLL2는 PLL1을 다시 활성화 하는것과 유사한 절차로 다시 활성화 할 수 있다.

1.PLL2에서 오실레이터의 모든 클럭도메인을 전환한다.
2.CSDISSET(Clock Source Disable Set Register)에 적절한 비트를 설정하여 PLL2을 비활성화한다.
이 동작은 PLL을 비활성화 하고 슬립신호가 더이상 구동되지 않도록 한다.
슬립이 지워질때까지 유효기간은 해제되지 않는다.
3. PLL2 재설정 시스템의 GLBSTAT에 RFSLIP,FBSLIP상태 플래그에 1을 쓰면 유효하다.
4.CSDISCLR 에 적절한 비트를 설정하여 PLL2를 다시 활성화 한다.
5.클럭도메인을 다시 PLL2으로 전환한다.

14.5.5 PLL Modulation Depth Measurement

PLL은 변조의 깊이를 추정하기 위한 회로를 가지고 있다.
이 회로는 변조파형의 고정된 창(SSW_CAPTURE_COUNT in SSWPLL2)과 전체 파형의 클럭엣지를 통해 클럭엣지를 카운트 한다.(SSW_CLKOUT_COUNT in SSWPLL3)
캡쳐는 TAP_COUNTER_DIS에 설정된 SSW_CLKOUT_COUNTER의 미리 결정된 수의 클럭 엣지 이후에
종료 된다. 변조 파형 당 2 × NR 이 있다. 변조 깊이를 추정하기위한 절차는 다음과 같다.

1.GCLK는 오실레이터에 의해 소스되고, PLL은 변조로 활성화 된다.
SSWPLL1는 다음과 같이 구성되어있다.
a) CAPTURE_WINDOW_INDEX는 NR과 동일하게 설정된다.
b) COUNTER_RESET이 설정된다.
c) TAP_COUNTER_DIS는 SSW_CLKOUT_COUNT 캡쳐 후 측정을 사용하지 않도록 설정된다.
설정 탭을 설정하고 변조주기가 끝나면 측정이 비활성화된다.
d)EXT_COUNTER_EN이 지워졌는지 확인한다. 

2.SSW_CAPTURE_COUNT 및 SSW_CLKOUT_COUNT가 모두 지워졌는지 확인한다.
3.COUNTER_EN을 설정하고 COUNTER_RESET를 지운다. 이 단계는 재설정을 해제하고 카운터가 계산을 시작할수 있게한다.
4.대기 루프가 끝나면 COUNTER_READ_READY를 폴링하여 설정한다.
 비트가 설정되면 SSW_CAPTURE_COUNT 및 SSW_CLKOUT_COUNT를 읽는다.
5.변조심도를 다음과 같이 계산한다.
 

14.5.6 PLL Frequency Measurement Circuit

변조 깊이를 측정하는데 사용되는회로는 동일한 회로를 사용하여 PLL의 평균 주파수를 측정할수 있다.
이 모드에서는 발진기가 SSW_CAPTURE_COUNT로 캡처되는 동안 PLL 출력 (R 디바이더 이전)이 SSW_CLKOUT_COUNT에 캡처된다.
PLL 주파수 측정 회로를 사용하는 절차는 다음과 같다.

1. PLL이 활성화 된 상태에서 EXT_COUNTER_EN을 설정한다.
2. COUNTER_EN을 설정한다.
 이 비트는 SSW_CAPTURE_COUNT 및 SSW_CLKOUT_COUNT를 모두 지운 다음 즉시 카운팅 할 수있게한다.
3. 일부 소프트웨어 지연 루프를 기다린다.
4. COUNTER_EN을 지운다.
COUNTER_READ_READY가 설정 될 때까지 기다린다.
SSW_CAPTURE_COUNT와 SSW_CLKOUT_COUNT를 읽고 PLL 곱셈의 비율을 다음과 같이 계산해라.


14.5.7 PLL2

PLL2는 GCM 클럭 소스 6을 구동한다.
PLL은이 PLL 인스턴스에서 변조가 비활성화된다는 점을 제외하면 PLL1과 동일하다.
또한 PLL은 일반적으로 시스템을 클록하지 않으며 자동 전환 기능이 없다.
모든 PLL 오류는 CPU에서 처리 할 수 있다.
PLL2는 PLLCTL3을 통해 프로그래밍된다.

14.6 Control Registers

클록 모듈은 시스템 및 주변 장치 내에 위치한 두 개의 레지스터 (PLLCTL1 및 PLLCTL2)를 가지고있다.
다른 시스템 및 주변 장치 제어 레지스터에 플러스4바이트 하여 가지고 있다.

전원이 켜지면 FM-PLL이 꺼진다.
클럭 소스는 (CSDIS)에서 적절한 비트를 클리어하거나 클럭 소스 디스 에이블 클리어 레지스터
(CSDISCLR)을 제공한다.[CSDISCLR 및 클럭 소스 비활성화 세트 레지스터 (CSDISSET)는 또한 PLL과 오실레이터 (및 다른 클럭 소스)를 활성화 / 비활성화한다.]

LPOCLKDET 모듈은 기준 오실레이터의 문제가 감지되면
시스템 및 주변 장치 제어 레지스터의 GLBSTAT (전역 상태 레지스터)에 OSCFAIL 플래그를 생성한다.
슬립 신호는 또한 Global Status Register의 RFSLIP 및 FBSLIP 상태 플래그에 등록되고
(GLBSTAT)를 시스템 및 주변 장치 제어 레지스터에 추가하여 클록 오류의 원인을 나타낸다.

PLL에 대한 적절한 CLKSRnV 비트는 시스템 및 주변 장치 제어 레지스터의 클럭 소스 유효 상태 레지스터 (CSVSTAT)에 설정된다.
다음 절에서는 시스템 모듈에 사용되는 두 개의 PLL 레지스터에 대해 설명한다.
이 레지스터는 8 비트, 16 비트 및 32 비트 쓰기 액세스를 지원한다.
이 레지스터의 리셋 값은 5MHz ~ 20MHz 범위의 입력 주파수가 유효한 클럭을 생성하도록 구성된다.


14.7 Phase-Locked Loop Theory of Operation (PLL의 동작원리)

PLL블록은 6개의 논리하위 블록으로 구성되어있다.
*파형 주파수 감지기
*충전펌프
*전압제어 발진기
*주파수 변조기
*슬립 감지기


14-9 그림은 기본 PLL 회로의 하위 블록을보여준다.

VCO는 PFD로 들어가는 두 개의 신호가 같은 위상과 주파수를 가질 때까지 주파수를 조정한다.
피드백 경로 (VCO에서 PFD까지)는 피드백 신호의 주파수를 2 * NF로 나눈다.
이 피드백 디바이더는 VCO가 내부 주파수 (OSCIN / NR)보다 큰 2 * NF 배의 주파수를 생성해야한다.
순방향 경로 (VCO에서 PLL CLK로)에서 ÷2 블록은 깨끗한 듀티 사이클을 생성한다.

-듀티사이클: 펄스의 주기에 대한 펄스폭의 비율을 나타내는주기.


14.7.1 Phase-Frequency Detector(위상주파수검출기 PFD)
PFD는 입력 기준 위상 ,주파수 ,피드백분배기와 두개의 신호 발생.. ->이 세가지를 비교한다.
두개의 신호는: 전압펌프를 구동하는 상향펄스와 하향펄스를 보여줌.
LF핀에서 회로에의해 통합될때 발생하는 전하가 그림 14-10과 같이 VCO 제어 전압을 제공한다.


14.7.2 Charge Pump and Loop Filter

전압펌프는 (CP)는 위상 주파수 검출기 (PFD)에서 나오는 펄스를 기반으로 루프 필터에 전하를 추가하거나 제거한다.
필터 출력 신호의 두 가지 구성 요소,즉 합계 구성 요소와 비례 구성 요소가 함께 합산된다.
통합 구성 요소는 VCO로가는 DC 레벨을 유지하여 주파수를 설정하고
비례 구성 요소는 VCO가 위상 변화를 추적하여 지터를 최소화한다.
필터에 필요한 커패시터 및 레지스터는 실리콘에 통합되어 있다.

14.7.3 Voltage-Controlled Oscillator

VCO의 출력 주파수는 입력 제어 전압에 비례하며, 통합 루프 필터를 통해 차지 펌프에 의해 생성된다.
VCO가 너무 느리게 발진하면 피드백 위상이 PFD에서 기준 위상보다 늦기 시작하여 VCO에서 제어 전압이 높아진다.
반대로 VCO가 너무 빠르게 발진하면 피드백 위상이 PFD에서 기준 위상을 앞 당기기 시작하여 VCO에서 제어 전압이 감소한다.
이 두 가지 동작은 VCO가 레퍼런스의 올바른 주파수 배수로 유지되도록한다.

14.7.4 Frequency Modulation

PLL의 출력 클럭은 무 변조 출력 주파수를 중심으로 제어 된 방식으로 주파수를 변경한다.
변조 블록은 루프 필터에서 직접 VCO 주파수를 변조하고 삼각 주파수 변조를 생성한다. (그림 14-12 참조).


